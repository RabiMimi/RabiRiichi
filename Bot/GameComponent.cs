using HoshinoSharp.Hoshino;
using HoshinoSharp.Runtime;
using RabiRiichi.Riichi;
using System.Threading.Tasks;

namespace RabiRiichi.Bot {
    public class GameComponent : HoshinoComponent {
        public const int NumPlayers = 1;
        public UserList players = new UserList();
        public Game game;
        public HEvent ev;
        public HBot bot;

        public bool IsReady => players.Count >= NumPlayers;

        public void Reset() {
            players.Clear();
            game = new Game(this);
            ev = null;
            bot = null;
        }

        public override void Start() {
            Reset();
        }

        public async Task AddPlayer(HEvent ev, HBot bot) {
            if (IsReady || game.phase != GamePhase.Pending)
                return;
            var player = ev.sender;
            if (players.HasUser(player))
                return;
            players.Add(player);
            if (IsReady) {
                await bot.SendPrivate(ev.selfId, ev.userId.Value, "[CQ:image,file=base64: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]");
                //await StartGame(ev, bot);
            } else {
                await bot.Send(ev, $"人数：{players.Count}/{NumPlayers}");
            }
            return;
        }

        public async Task StartGame(HEvent ev, HBot bot) {
            this.bot = bot;
            this.ev = ev;
            game.phase = GamePhase.Running;
            await bot.Send(ev, $"人数：{players.Count}/{NumPlayers}，正在开始游戏……");
            await Task.Delay(1000);
            await game.Start();
            await Task.Delay(1000);
            await bot.Send(ev, $"游戏结束，后面还没写");
            Reset();
        }
    }
}
